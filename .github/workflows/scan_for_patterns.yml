name: General Patterns Scanner
run-name: General Patterns

on:
  pull_request:
    branches:
      - '**'

jobs:
  scan-files:
    name: ðŸ”Ž General Patterns Scanner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get list of changed files
        id: changes
        run: |
          echo "CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Scan for suspicious patterns
        continue-on-error: true
        run: |
          echo "ðŸ” Scanning for suspicious patterns in changed files..."

          patterns=(
            '\$_REQUEST\[\s*["'\''][^"'\''"]+["'\'']\s*\]\s*=[^=]'
            '\(string\)\s*\$_REQUEST'
            'SELECT\s*\*'
          )

          labels=(
            "Assignment to REQUEST variable"
            "Type casting with REQUEST variable"
            "Use of SELECT * in DB query"
          )

          declare -A file_label_issues
          found_issues=0

          for file in $CHANGED_FILES; do
            if [[ "$file" == .github/workflows/* ]]; then
              continue
            fi

            if [[ -f "$file" ]]; then
              for i in "${!patterns[@]}"; do
                pattern="${patterns[$i]}"
                label="${labels[$i]}"
                grep_output=$(awk '!/^\s*\/\//' "$file" | grep -En "$pattern")
          
                if [[ -n "$grep_output" ]]; then
                  key="$file|$label"
                  file_label_issues["$key"]="$grep_output"
                  found_issues=1
                fi
              done
            fi
          done

          declare -A file_aggregator

          for key in "${!file_label_issues[@]}"; do
            file="${key%%|*}"
            label="${key##*|}"
            entry=$'\n'"ðŸ”¸ [$label]"$'\n'"${file_label_issues[$key]}"
            file_aggregator["$file"]+="$entry"
          done

          if [[ $found_issues -eq 1 ]]; then
            if [[ $found_issues -eq 1 ]]; then
            echo "ðŸš« Suspicious patterns detected. Logging warnings to summary..."

            echo "### âš ï¸ Suspicious Patterns Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            for file in "${!file_aggregator[@]}"; do
              echo "::group::âŒ Found suspicious patterns in file $file"
              echo "${file_aggregator[$file]}"
              echo "::endgroup::"

              echo "**File: \`$file\`**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "${file_aggregator[$file]}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âœ… No suspicious patterns found."
            echo "### âœ… No suspicious patterns found" >> $GITHUB_STEP_SUMMARY
          fi
