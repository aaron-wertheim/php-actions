name: Scan for suspicious patterns

on:
  push:
    branches:
      - '**' 

jobs:
  scan-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get list of changed files
        id: changes
        run: |
          echo "CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Scan for suspicious patterns
        run: |
          echo "ğŸ” Scanning for suspicious patterns in changed files..."

          # Define patterns and labels
          patterns=(
            "\.dev"
            "$_REQUEST\[\s*['\"][^'\"]+['\"]\s*\]\s*="
          )
          labels=(
            ".dev usage"
            "\$_REQUEST[*] ="
          )

          found_issues=0

          for file in $CHANGED_FILES; do
            if [[ "$file" == .github/workflows/* ]]; then
            continue
            fi
          
            if [[ -f "$file" ]]; then
              for i in "${!patterns[@]}"; do
                pattern="${patterns[$i]}"
                label="${labels[$i]}"
                grep_output=$(grep -En "$pattern" "$file" | grep -vE '^\s*//')
                if [[ -n "$grep_output" ]]; then
                  echo "::group::âŒ Found forbidden pattern '$label' in file $file"
                  echo "$grep_output"
                  found_issues=1
                  echo "::endgroup::"
                fi
              done
            fi
          done

          if [[ $found_issues -eq 1 ]]; then
            echo "ğŸš« Suspicious patterns detected. Please fix before committing."
            exit 1
          else
            echo "âœ… No suspicious patterns found."
          fi
      
