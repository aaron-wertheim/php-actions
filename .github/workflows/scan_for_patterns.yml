name: Scan for general suspicious patterns
run-name: üîé General Pattern Scanner

on:
  push:
    branches:
      - '**'

jobs:
  scan-files:
    name: üîé General Pattern Scanner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get list of changed files
        id: changes
        run: |
          echo "CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Scan for general suspicious patterns
        run: |
          echo "üîç Scanning for general suspicious patterns in changed files..."

          patterns=(
            '$_REQUEST\[\s*['\"][^'\"]+['\"]\s*\]\s*=[^=]'
            "\(string\)\s*$_REQUEST"
            "SELECT\s+\*"
          )

          labels=(
            "Assignment to REQUEST variable"
            "Type casting with REQUEST variable"
            "Use of SELECT * in query"
          )

          declare -A file_issues
          found_issues=0

          for file in $CHANGED_FILES; do
            if [[ "$file" == .github/workflows/* ]]; then
              continue
            fi

            if [[ -f "$file" ]]; then
              output=""
              for i in "${!patterns[@]}"; do
                pattern="${patterns[$i]}"
                label="${labels[$i]}"
                grep_output=$(awk '!/^\s*\/\//' "$file" | grep -En "$pattern")

                if [[ -n "$grep_output" ]]; then
                  output+=$'\n'"üî∏ [$label]"
                  output+=$'\n'"$grep_output"
                  found_issues=1
                fi
              done

              if [[ -n "$output" ]]; then
                file_issues["$file"]="$output"
              fi
            fi
          done

          for file in "${!file_issues[@]}"; do
            echo "::group::‚ùå Found general suspicious pattern(s) in file $file"
            echo "${file_issues[$file]}"
            echo "::endgroup::"
          done

          if [[ $found_issues -eq 1 ]]; then
            echo "üö´ Suspicious patterns detected. Please fix before committing."
            exit 1
          else
            echo "‚úÖ No suspicious patterns found."
          fi
